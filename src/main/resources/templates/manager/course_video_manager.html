<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="ThemeBucket">
    <link rel="shortcut icon" href="#" type="image/png">

    <title>课程视频管理</title>

    <!--data table-->
    <link rel="stylesheet" href="js/data-tables/DT_bootstrap.css" />

    <div th:include="common/admin_common :: common_head"></div>
</head>

<body class="sticky-header">

<section>
    <!-- left side start-->
    <div th:replace="common/admin_common :: #left"></div>
    <!-- left side end-->

    <!-- main content start-->
    <div class="main-content" >

        <!-- header section start-->
        <div th:replace="common/admin_common :: #head"></div>
        <!-- header section end-->

        <!-- page heading start-->
        <div class="page-heading">
            <h3>
                课程视频管理
            </h3>
            <ul class="breadcrumb">
                <ul class="breadcrumb">
                    <li>
                        <a th:href="@{/admin}">admin</a>
                    </li>
                    <li>
                        <a th:href="@{/course_manager}">课程管理</a>
                    </li>
                    <li class="active"> 课程视频管理 </li>
                </ul>
            </ul>
        </div>
        <!-- page heading end-->

        <!--body wrapper start-->
        <div class="wrapper">
            <div class="row">
                <div class="col-sm-12">
                    <section class="panel">
                        <header class="panel-heading">
                            课程列表
                            <span class="tools pull-right">
                        <a href="javascript:;" class="fa fa-chevron-down"></a>
                        <a href="javascript:;" class="fa fa-times"></a>
                     </span>
                        </header>
                        <div class="panel-body">
                            <div class="adv-table editable-table ">
                                <div class="clearfix">
                                    <div class="btn-group">
                                        <button id="addnbutton" class="btn btn-primary" data-toggle="modal" data-target="#myModal">
                                            添加新课程视频 <i class="fa fa-plus"></i>
                                        </button>
                                    </div>
<!--                                                                        add button start-->
<!--                                     Modal-->
                                    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                                        <div class="modal-dialog" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                                    <h4 class="modal-title" id="myModalLabel">添加新课程</h4>
                                                </div>
                                                <div class="modal-body">
                                                    <!--                                                    add new form start-->
                                                    <form id="form" class="form-horizontal" method="post" enctype="multipart/form-data" >
                                                        <div class="form-group">
                                                            <label for="inputVideoTitle" class="col-sm-2 control-label">VideoTitle</label>
                                                            <div class="col-sm-10">
                                                                <input type="text" name="videoTitle" class="form-control" id="inputVideoTitle" placeholder="CourseName">
                                                                <span class="help_block"></span>
                                                            </div>
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="inputVideoOrder" class="col-sm-2 control-label">VideoOrder</label>
                                                            <div class="col-sm-10">
                                                                <input type="text" class="form-control" id="inputVideoOrder"  name="videoOrder">
                                                                <span class="help_block"></span>
                                                            </div>
                                                        </div>
                                                        <input type="hidden" class="form-control" id="CourseId"  name="courseId" th:value="${courseId}">
                                                        <div class="form-group">
                                                            <label for="inputVideo" class="col-sm-2 control-label">Video</label>
                                                            <div class="col-sm-10">
                                                                <input type="file" id="inputVideo"  class="form-control" name="inputVideo">
                                                                <span class="help_block"></span>
                                                                <p class="help-block">请选择视频上传（只支持【.mp4】格式视频上传）</p>
                                                            </div>
                                                        </div>
                                                    </form>
                                                    <!--                                                    add new form end-->
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                                                    <button type="button" class="btn btn-primary" th:courseId="${courseId}" id="saveVideo">保存</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
<!--                                                                        add button end-->
                                    <div class="btn-group pull-right">
                                        <button class="btn btn-default" id="backBtn">返回课程管理页</button>
                                    </div>
                                </div>
                                <div class="space15"></div>
                                <table class="table table-striped table-hover table-bordered" id="editable-sample">
                                    <thead>
                                    <tr>
                                        <th>VideoOrder</th>
                                        <th>VideoTitle</th>
                                        <th>Delete</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr class="" th:each="video : ${videoByCourseId}">
                                        <td th:text="${video.videoOrder}"></td>
                                        <td th:text="${video.videoTitle}"></td>
                                        <td><button type="button" id="deleteVideo" th:courseId="${courseId}" th:videoId="${video.videoId}" class="btn btn-warning">删除课程</button></td>

                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>
        <!--body wrapper end-->

        <!--footer section start-->
        <footer>
            2020 &copy; AdminEx by ThemeBucket </a>
        </footer>
        <!--footer section end-->


    </div>
    <!-- main content end-->
</section>

<!-- Placed js at the end of the document so the pages load faster -->
<script src="js/jquery-1.10.2.min.js"></script>
<script src="js/jquery-ui-1.9.2.custom.min.js"></script>
<script src="js/jquery-migrate-1.2.1.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/modernizr.min.js"></script>
<script src="js/jquery.nicescroll.js"></script>

<!--data table-->
<script type="text/javascript" src="js/data-tables/jquery.dataTables.js"></script>
<script type="text/javascript" src="js/data-tables/DT_bootstrap.js"></script>

<!--common scripts for all pages-->
<script src="js/scripts.js"></script>

<!--script for editable table-->
<script src="js/editable-table.js"></script>

<!-- END JAVASCRIPTS -->
<script>
    jQuery(document).ready(function() {
        EditableTable.init();
    });
    //显示校验信息方法
    function show_validate_msg(ele,status,msg){
        $(ele).parent().removeClass("has-error has-success");
        $(ele).next("span").text("");
        if ("success"==status){
            $(ele).parent().addClass("has-success");
            $(ele).next("span").text(msg);
        }else if ("error"==status){
            $(ele).parent().addClass("has-error");
            $(ele).next("span").text(msg);
        }
    }
    //校验表单数据
    function validate_add_form(){
        let courseId = $("#CourseId").val();
        //    拿到校验数据，使用正则表达式
        let inputVideoTitle = $("#inputVideoTitle").val();
        let inputVideoOrder = $("#inputVideoOrder").val();
        let regCourseName = /^.{2,20}$/;
        $.ajax({
            url:"/videoTitleIsHas?videoTitle="+inputVideoTitle+"&courseId="+courseId,
            type:"GET",
            success:function (result) {
                // alert(result);
                if (result== 0){
                    show_validate_msg("#inputVideoTitle","error","视频标题已存在，请更改");
                    return false;
                }
            }
        })
        if(!regCourseName.test(inputVideoTitle)){
            // alert("昵称格式为2-6位中英文混合");
            show_validate_msg("#inputVideoTitle","error","视频标题长度限制为2-20位");
            return false;
        }else {
            show_validate_msg("#inputVideoTitle","success","");
        }

        $.ajax({
            url:"/videoOrderIsHas?videoOrder="+inputVideoOrder+"&courseId="+courseId,
            type:"GET",
            success:function (result) {
                // alert(result);
                if (result== 0){
                    show_validate_msg("#inputVideoOrder","error","视频顺序号已存在，请更改");
                    return false;
                }
            }
        })

        let regTeachEmail = /^(?:[1-9]?\d|100)$/;
        if(!regTeachEmail.test(inputVideoOrder)){
            show_validate_msg("#inputVideoOrder","error","课程视频顺序只能用数字1-100");
            return false;
        }else {
            show_validate_msg("#inputVideoOrder","success","");
        }

        let inputVideo = $("#inputVideo").val();
        let regPhoto = /^.*?\.(mp4)$/;
        if(!regPhoto.test(inputVideo)){
            show_validate_msg("#inputVideo","error","请传入【.mp4】格式文件");
            return false;
        }else {
            show_validate_msg("#inputVideo","success","");
        }

        return true;

    }




    $("#backBtn").click(function () {
        window.location.href="/course_manager";
    })
    //点击进入课程视频修改界面
    // $(document).on("click","#editVideo",function () {
    //     let courseId = $(this).attr("courseId");
    //     window.location.href="/course_video_manager/"+courseId;
    // })
    //新增视频
    $("#saveVideo").click(function(){
        //    模态框填写表单数据交给服务器
        if(!validate_add_form()){
            //    进行校验
            return false;
        }
        //    发送ajax请求保存视频
        let form = document.getElementById("form");
       let courseId= $(this).attr("courseId");
        var formdata = new FormData(form);
        // alert(formdata.get("userPhoto"))
        $.ajax({
            url:"/course_video_manager",
            type:"POST",
            data: formdata,
            async: false,
            cache: false,
            contentType: false,
            processData: false,
            success:function(result){
                //提示信息
                alert(result.msg);
                //隐藏模态框
                $("#myModal").modal('hide');
                //清除模态框数据
                $(':input','#form')
                    .not(':button, :submit, :reset, :hidden')
                    .val('')
                    .removeAttr('checked')
                    .removeAttr('selected');
                //重新载入界面
                window.location.href="/course_video_manager?courseId="+courseId;
            }
        })

    })
    //删除视频
    $(document).on("click","#deleteVideo",function () {
        //确认是否删除
        let videoName = $(this).parents("tr").find("td:eq(1)").text();
        let videoOrder = $(this).parents("tr").find("td:eq(0)").text();
        let videoId = $(this).attr("videoId");
        let courseId= $(this).attr("courseId");
        // alert(userId);

        if (confirm("确认删除视频["+videoName+"],排序["+videoOrder+"]吗？")){
            //    确认就删除
            $.ajax({
                url:"/course_video_manager/"+videoId,
                type:"DELETE",
                success:function(result){
                    alert(result.msg);
                    //重新载入界面
                    window.location.href="/course_video_manager?courseId="+courseId;
                }

            })
        }
    })
</script>

</body>
</html>
